<!DOCTYPE html>
<html>
<head>
  <title>Moniteur de Qualité d'Air - ENISE</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; text-align: center; margin: 0px auto; padding: 15px; }
    .container { width: 100%; max-width: 800px; margin: 0 auto; }
    .chart-container { position: relative; height: 300px; width: 100%; margin: 20px 0; }
    .data-box { background-color: #f0f0f0; border-radius: 10px; padding: 10px; margin: 10px; display: inline-block; width: 40%; }
    .navigation { margin: 20px 0; }
    .navigation a { 
      display: inline-block; 
      padding: 10px 20px; 
      background-color: #004080; 
      color: white; 
      text-decoration: none; 
      border-radius: 5px;
      margin: 0 10px;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-weight: bold;
    }
    .status.online {
      background-color: #d4edda;
      color: #155724;
    }
    .status.offline {
      background-color: #f8d7da;
      color: #721c24;
    }
    .room-selector {
      margin: 20px 0;
    }
    .room-selector select {
      padding: 10px;
      border-radius: 5px;
      font-size: 16px;
    }
    .last-update {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Moniteur de Qualité d'Air - ENISE</h2>
    
    <div class="navigation">
      <a href="index.html">Retour à l'accueil</a>
      <a href="Carterdc.html">Voir la carte</a>
    </div>
    
    <div class="room-selector">
      <label for="room">Sélectionnez une salle:</label>
      <select id="room" onchange="changeRoom()">
        <option value="local">Données locales</option>
        <option value="github">Données GitHub</option>
        <!-- D'autres salles peuvent être ajoutées ici -->
      </select>
    </div>
    
    <div id="statusBox" class="status">
      Chargement des données...
    </div>
    
    <div>
      <div class="data-box">
        <h3>CO2 équivalent</h3>
        <p id="co2">--</p>
      </div>
      <div class="data-box">
        <h3>COV Totaux</h3>
        <p id="tvoc">--</p>
      </div>
    </div>
    
    <div class="chart-container">
      <canvas id="co2Chart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="tvocChart"></canvas>
    </div>
    
    <div class="last-update" id="lastUpdate">
      Dernière mise à jour: --
    </div>
  </div>

  <script>
    // Configuration des graphiques
    var co2Data = [];
    var tvocData = [];
    var labels = [];
    var maxPoints = 50;
    var dataSource = "local"; // Par défaut, utiliser les données locales
    var updateInterval; // Variable pour stocker l'intervalle
    var lastData = null; // Pour stocker les dernières données reçues
    
    // Créer les graphiques
    var co2Chart = new Chart(document.getElementById('co2Chart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'CO2 (ppm)',
          data: co2Data,
          borderColor: 'rgba(255, 99, 132, 1)',
          backgroundColor: 'rgba(255, 99, 132, 0.2)',
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false
          }
        },
        animation: {
          duration: 500
        }
      }
    });
    
    var tvocChart = new Chart(document.getElementById('tvocChart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'TVOC (ppb)',
          data: tvocData,
          borderColor: 'rgba(54, 162, 235, 1)',
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false
          }
        },
        animation: {
          duration: 500
        }
      }
    });
    
    // Changer la source de données
    function changeRoom() {
      var roomSelect = document.getElementById('room');
      dataSource = roomSelect.value;
      
      // Réinitialiser les graphiques
      co2Data = [];
      tvocData = [];
      labels = [];
      updateCharts();
      
      // Réinitialiser l'intervalle
      clearInterval(updateInterval);
      updateInterval = setInterval(getReadings, 1000);
      
      // Mettre à jour les données immédiatement
      getReadings();
    }
    
    // Mettre à jour les graphiques
    function updateCharts() {
      co2Chart.data.labels = labels;
      co2Chart.data.datasets[0].data = co2Data;
      tvocChart.data.labels = labels;
      tvocChart.data.datasets[0].data = tvocData;
      co2Chart.update();
      tvocChart.update();
    }
    
    // Obtenir les données du serveur
    function getReadings() {
      if (dataSource === "local") {
        getLocalData();
      } else if (dataSource === "github") {
        getGitHubData();
      }
    }
    
    // Obtenir les données depuis l'ESP32 local
    function getLocalData() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            try {
              var data = JSON.parse(this.responseText);
              updateDisplayWithData(data);
              
              // Mettre à jour le statut
              var statusBox = document.getElementById("statusBox");
              statusBox.className = "status online";
              statusBox.innerHTML = "Connecté au capteur local";
            } catch (e) {
              console.error("Erreur de parsing JSON:", e);
              setOfflineStatus("Erreur de format de données");
            }
          } else {
            // Erreur de connexion
            setOfflineStatus("Capteur local non disponible");
          }
        }
      };
      
      // L'URL doit être ajustée à votre environnement
      // En local, utilisez '/readings'
      // Pour les tests, utilisez l'URL complète de l'ESP32
      var url = "/readings";
      
      // Si vous êtes en train de tester dans un navigateur qui n'est pas connecté à l'ESP32,
      // vous pouvez temporairement commenter la ligne suivante et la remplacer par :
      // url = "http://192.168.1.XXX/readings";  // Remplacer XXX par l'IP de votre ESP32
      
      xhr.open("GET", url, true);
      xhr.timeout = 5000; // 5 secondes timeout
      xhr.ontimeout = function() {
        setOfflineStatus("Capteur local non disponible (timeout)");
      };
      xhr.send();
    }
    
    // Obtenir les données depuis GitHub
    function getGitHubData() {
      var xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (this.readyState == 4) {
          if (this.status == 200) {
            try {
              var response = JSON.parse(this.responseText);
              
              // Décoder le contenu en base64
              var content = atob(response.content);
              var data = JSON.parse(content);
              
              // Mettre à jour l'affichage avec les dernières données
              if (data.reading) {
                updateDisplayWithData(data.reading);
                
                // Mettre à jour le statut
                var statusBox = document.getElementById("statusBox");
                statusBox.className = "status online";
                statusBox.innerHTML = "Données récupérées depuis GitHub";
              }
            } catch (e) {
              console.error("Erreur de parsing JSON:", e);
              setOfflineStatus("Erreur de format de données GitHub");
            }
          } else {
            // Erreur de connexion à GitHub
            setOfflineStatus("Données GitHub non disponibles");
          }
        }
      };
      
      // URL de votre fichier JSON sur GitHub
      var githubUrl = "https://api.github.com/repos/Simono18-02/Projet-de-promo/contents/data.json";
      xhr.open("GET", githubUrl, true);
      xhr.timeout = 10000; // 10 secondes timeout pour GitHub
      xhr.ontimeout = function() {
        setOfflineStatus("GitHub non disponible (timeout)");
      };
      xhr.send();
    }
    
    // Définir le statut hors ligne
    function setOfflineStatus(message) {
      var statusBox = document.getElementById("statusBox");
      statusBox.className = "status offline";
      statusBox.innerHTML = message;
    }
    
    // Mettre à jour l'affichage avec les données
    function updateDisplayWithData(data) {
      // Vérifier si les données sont différentes des dernières reçues
      if (!lastData || data.co2 !== lastData.co2 || data.tvoc !== lastData.tvoc) {
        // Mettre à jour les affichages
        document.getElementById("co2").innerHTML = data.co2 + " ppm";
        document.getElementById("tvoc").innerHTML = data.tvoc + " ppb";
        
        // Ajouter les données aux graphiques
        var now = new Date();
        var timeString = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();
        labels.push(timeString);
        co2Data.push(data.co2);
        tvocData.push(data.tvoc);
        
        // Limiter le nombre de points
        if (labels.length > maxPoints) {
          labels.shift();
          co2Data.shift();
          tvocData.shift();
        }
        
        // Mettre à jour les graphiques
        updateCharts();
        
        // Mettre à jour l'horodatage
        document.getElementById("lastUpdate").innerHTML = 
          "Dernière mise à jour: " + now.toLocaleString();
        
        // Stocker les dernières données
        lastData = { ...data };
      }
    }
    
    // Initialiser l'intervalle de mise à jour
    updateInterval = setInterval(getReadings, 1000);
    
    // Première lecture
    getReadings();
  </script>
</body>
</html>
